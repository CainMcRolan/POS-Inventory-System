<?php
require('../../fpdf/fpdf.php');
require('../../helper/connect.php');

session_start();

// Fetch daily sales data
$date = date('Y-m-d'); // Current date in YYYY-MM-DD format
$startOfDay = $date . ' 00:00:00';
$endOfDay = $date . ' 23:59:59';

$query = "SELECT * FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";


class PDF extends FPDF
{
   function __construct($orientation = 'P', $unit = 'mm', $size = 'A4')
   {
       parent::__construct($orientation, $unit, $size);
       $this->SetMargins(2, 2, 2); // Set margins to zero
   }
    // Page header
    function Header()
    {
        // Title
        $this->SetFont('Arial', 'B', 6);
        $this->Cell(0, 2, 'CRT Minimart Cashier Report', 0, 1, 'C');
        $this->Ln(1);
        // Date and time
        $this->SetFont('Arial', '', 5);
        $this->Cell(0, 2, 'Date: ' .$_SESSION['$selected_date'], 0, 1, 'C');
        $this->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');
        // Generated by
        $this->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
        $this->Ln(2);
    }

    function cashierReport(){
      global $connection;
      $date = $_SESSION['$selected_date']; 
      $startOfDay = $date . ' 00:00:00';
      $endOfDay = $date . ' 23:59:59';
  
      $this->SetFont('Arial', 'B', 5);
      $this->Cell(0, 2, 'Cashier Report:', 0, 1, 'C');
  
      // Table headers
      $headers = array('Time', 'Cashier', 'Item', 'Qty', 'Total');
      $this->SetFont('Arial', '', 5);
      $this->Cell(10, 2, $headers[0], 1, 0, 'C');
      $this->Cell(10, 2, $headers[1], 1, 0, 'C');
      $this->Cell(15, 2, $headers[2], 1, 0, 'C');
      $this->Cell(5, 2, $headers[3], 1, 0, 'C');
      $this->Cell(12, 2, $headers[4], 1, 0, 'C');
      $this->Ln();
  
      // Fetch sales data
      $query_sales = "SELECT date, cashier_name, name, sold, cash_received FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
      $result_sales = mysqli_query($connection, $query_sales);
  
      // Table data
      $this->SetFont('Arial', '', 5);
      while ($row_sale = mysqli_fetch_assoc($result_sales)) {
          $sale_date = $row_sale['date'];
          $sale_time = date('H:i:s', strtotime($sale_date)); // Format date to show only the time
          $cashier_name = $row_sale['cashier_name'];
          $item_name = $row_sale['name'];
          $quantity_sold = $row_sale['sold'];
          $total_cash = $row_sale['cash_received'];
  
          // Add each sale to the table
          $this->Cell(10, 2, $sale_time, 1, 0, 'C');
          $this->Cell(10, 2, $cashier_name, 1, 0, 'C');
          $this->Cell(15, 2, $item_name, 1, 0, 'C');
          $this->Cell(5, 2, $quantity_sold, 1, 0, 'C');
          $this->Cell(12, 2, '$' . number_format($total_cash, 2), 1, 0, 'C');
          $this->Ln();
      }
      $this->Ln(2);
  }
  


    // Thank you message
    function ThankYouMessage()
    {
        $this->SetFont('Arial', 'I', 4);
        $this->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
        $this->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
        $this->Ln(1);
    }
}

// Create a new PDF instance
$pdf = new PDF('P','mm',array(83, 55)); // Adjusted width and height for vertical orientation
$pdf->AddPage();

// Add sections to the PDF
$pdf->cashierReport();
$pdf->ThankYouMessage();

// Output the PDF
$pdf->Output('I', 'Daily_Terminal_Report_' . $date . '.pdf');
?>
