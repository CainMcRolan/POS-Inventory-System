<?php
require('../../fpdf/fpdf.php');
require('../../helper/connect.php');

session_start();

// Determine the date to use
date_default_timezone_set('Asia/Manila');
$date = isset($_SESSION['$selected_date']) ? $_SESSION['$selected_date'] : date('Y-m-d');
$startOfDay = $date . ' 00:00:00';
$endOfDay = $date . ' 23:59:59';

// Fetch sales data
$query = "SELECT * FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";

// Create a new PDF instance
$pdf = new FPDF('P', 'mm', array(83, 55)); // Adjusted width and height for vertical orientation
$pdf->AddPage();
$pdf->SetMargins(5, 5, 0); // Set margins to zero
$pdf->SetAutoPageBreak(true, 5.00);

// Page header
$pdf->SetFont('Arial', 'B', 6);
$pdf->Cell(37, 1, 'CRT Minimart Cashier Report', 0, 1, 'C');
$pdf->Ln(1);

// Date and time
$pdf->SetFont('Arial', '', 5);
$pdf->Cell(0, 2, 'Date: ' . $date, 0, 1, 'C');
$pdf->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');

// Generated by
$pdf->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
$pdf->Ln(1);

// Cashier Report
$pdf->SetFont('Arial', 'B', 5);
$pdf->Cell(0, 2, 'Cashier Report:', 0, 1, 'C');

// Fetch sales data
$query_sales = "SELECT date, cashier_name, name, sold, cash_received FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
$result_sales = mysqli_query($connection, $query_sales);

// Table data
$pdf->SetFont('Arial', '', 5);
while ($row_sale = mysqli_fetch_assoc($result_sales)) {
    $sale_date = $row_sale['date'];
    $sale_time = date('H:i:s', strtotime($sale_date)); // Format date to show only the time
    $cashier_name = $row_sale['cashier_name'];
    $item_name = $row_sale['name'];
    $quantity_sold = $row_sale['sold'];
    $total_cash = $row_sale['cash_received'];

    // Add each sale to the table in the new format
    $pdf->Cell(15, 2, 'Time', 0, 0, 'L');
    $pdf->Cell(30, 2, $sale_time, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Name', 0, 0, 'L');
    $pdf->Cell(30, 2, $cashier_name, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Item', 0, 0, 'L');
    $pdf->Cell(30, 2, $item_name, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Qty', 0, 0, 'L');
    $pdf->Cell(30, 2, $quantity_sold, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Total', 0, 0, 'L');
    $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
    
    // Add break line
    $pdf->Cell(0, 2, str_repeat('.', 88), 0, 1, 'L');
    $pdf->Ln(0);
}
$pdf->Ln(1);

// Thank you message
$pdf->SetFont('Arial', 'I', 4);
$pdf->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
$pdf->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
$pdf->Ln(1);

// Output the PDF
$pdf->Output('I', 'Cashier_Report' . $date . '.pdf');
?>
