<?php
    require('../../fpdf/fpdf.php');
    require('../../helper/connect.php');

    session_start();

    // Fetch daily sales data
    date_default_timezone_set('Asia/Manila');
    $date = isset($_SESSION['$selected_date']) ? $_SESSION['$selected_date'] : date('Y-m-d'); // Use session date if set, otherwise current date
    $startOfDay = $date . ' 00:00:00';
    $endOfDay = $date . ' 23:59:59';

    // print_r($_SESSION['$selected_hour'] . '<br>');
    
    $currentHour = $_SESSION['$selected_hour'] ?? date('H');    
    $nextHour = $currentHour + 1;
    $startOfDay = $date . ' ' . sprintf('%02d', $currentHour) . ':00:00';
    $endOfDay = $date . ' ' . sprintf('%02d', $nextHour) . ':00:00';

    // print_r($currentHour . '<br>');
    // print_r($nextHour . '<br>');
    // print_r($startOfDay . '<br>');
    // print_r($endOfDay . '<br>');

    $startHour = date('H:i', strtotime($startOfDay));
    $endHour = date('H:i', strtotime($endOfDay));

    // Create a new PDF instance
    $pdf = new FPDF('P', 'mm', array(83, 55)); // Adjusted width and height for vertical orientation
    $pdf->AddPage();
    $pdf->SetMargins(5, 5, 2); // Set margins
    $pdf->SetAutoPageBreak(true, 5.00);


    // Page header
    $pdf->SetFont('Arial', 'B', 6);
    $pdf->Cell(37, 2, 'CRT Minimart Hourly Report: ' . $startHour . '-' . $endHour, 0, 1, 'C');
    $pdf->Ln(1);

    // Date and time
    $pdf->SetFont('Arial', '', 5);
    $pdf->Cell(0, 2, 'Date: ' . $date, 0, 1, 'C');
    $pdf->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');
    $pdf->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
    $pdf->Ln(1);


    // Sales summary
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Sales Summary:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch total sales
    $query_total_sales = "SELECT SUM(cash_received) AS total_sales FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_sales = mysqli_query($connection, $query_total_sales);
    $total_sales_row = mysqli_fetch_assoc($result_total_sales);
    $total_sales = $total_sales_row['total_sales'];

    // Fetch number of transactions
    $query_num_transactions = "SELECT COUNT(*) AS num_transactions FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_num_transactions = mysqli_query($connection, $query_num_transactions);
    $num_transactions_row = mysqli_fetch_assoc($result_num_transactions);
    $num_transactions = $num_transactions_row['num_transactions'];

    // Fetch total sold item quantity
    $query_total_sold_items = "SELECT SUM(sold) AS total_sold_items FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_sold_items = mysqli_query($connection, $query_total_sold_items);
    $total_sold_items_row = mysqli_fetch_assoc($result_total_sold_items);
    $total_sold_items = $total_sold_items_row['total_sold_items'];

    $pdf->SetFont('Arial', '', 5);
    $pdf->Cell(0, 2, 'Total Sales: $' . number_format($total_sales, 2), 0, 1, 'C');
    $pdf->Cell(0, 2, 'Number of Transactions: ' . $num_transactions, 0, 1, 'C');
    $pdf->Cell(0, 2, 'Total Sold Items: ' . $total_sold_items, 0, 1, 'C');
    $pdf->Ln(2);

    // Detailed sales breakdown
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Detailed Sales Breakdown:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch unique categories
    $query_categories = "SELECT DISTINCT category FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_categories = mysqli_query($connection, $query_categories);

    // Prepare data array
    while ($row_category = mysqli_fetch_assoc($result_categories)) {
        $category = $row_category['category'];

        // Fetch total quantity sold for this category
        $query_qty = "SELECT SUM(sold) AS total_qty FROM sale WHERE category = '$category' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_qty = mysqli_query($connection, $query_qty);
        $row_qty = mysqli_fetch_assoc($result_qty);
        $total_qty = $row_qty['total_qty'];

        // Fetch total cash received for this category
        $query_total = "SELECT SUM(cash_received) AS total_cash FROM sale WHERE category = '$category' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total = mysqli_query($connection, $query_total);
        $row_total = mysqli_fetch_assoc($result_total);
        $total_cash = $row_total['total_cash'];

        // Print data
        $pdf->Cell(15, 2, 'Category:', 0, 0, 'L');
        $pdf->Cell(30, 2, $category, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Quantity:', 0, 0, 'L');
        $pdf->Cell(30, 2, $total_qty, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Total Sales:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
        $pdf->Cell(0, 2, str_repeat('.', 90), 0, 1, 'L');
    }

    $pdf->Ln(2);

    // Itemized sales
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Itemized Sales:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch unique item names
    $query_items = "SELECT DISTINCT name FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_items = mysqli_query($connection, $query_items);

    // Prepare data array
    while ($row_item = mysqli_fetch_assoc($result_items)) {
        $item_name = $row_item['name'];

        // Fetch total quantity sold for this item
        $query_qty = "SELECT SUM(sold) AS total_qty FROM sale WHERE name = '$item_name' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_qty = mysqli_query($connection, $query_qty);
        $row_qty = mysqli_fetch_assoc($result_qty);
        $total_qty = $row_qty['total_qty'];

        // Fetch total cash received for this item
        $query_total = "SELECT SUM(cash_received) AS total_cash FROM sale WHERE name = '$item_name' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total = mysqli_query($connection, $query_total);
        $row_total = mysqli_fetch_assoc($result_total);
        $total_cash = $row_total['total_cash'];

        // Print data
        $pdf->Cell(15, 2, 'Product Name:', 0, 0, 'L');
        $pdf->Cell(30, 2, $item_name, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Quantity:', 0, 0, 'L');
        $pdf->Cell(30, 2, $total_qty, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Total Sales:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
        $pdf->Cell(0, 2, str_repeat('.', 90), 0, 1, 'L');
    }

    $pdf->Ln(4);

    //Cashier Report
    // Fetch sales data
    $query = "SELECT * FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";

    // Cashier Report
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Cashier Report:', 0, 1, 'C');

    // Fetch sales data
    $query_sales = "SELECT date, cashier_name, name, sold, cash_received FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_sales = mysqli_query($connection, $query_sales);

    // Table data
    $pdf->SetFont('Arial', '', 5);
    while ($row_sale = mysqli_fetch_assoc($result_sales)) {
        $sale_date = $row_sale['date'];
        $sale_time = date('H:i:s', strtotime($sale_date)); // Format date to show only the time
        $cashier_name = $row_sale['cashier_name'];
        $item_name = $row_sale['name'];
        $quantity_sold = $row_sale['sold'];
        $total_cash = $row_sale['cash_received'];

        // Add each sale to the table in the new format
        $pdf->Cell(15, 2, 'Time', 0, 0, 'L');
        $pdf->Cell(30, 2, $sale_time, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Name', 0, 0, 'L');
        $pdf->Cell(30, 2, $cashier_name, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Item', 0, 0, 'L');
        $pdf->Cell(30, 2, $item_name, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Qty', 0, 0, 'L');
        $pdf->Cell(30, 2, $quantity_sold, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Total', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
        
        // Add break line
        $pdf->Cell(0, 2, str_repeat('.', 88), 0, 1, 'L');
        $pdf->Ln(0);
    }
    $pdf->Ln(5);


    //Cash Report
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Cash Report:', 0, 1, 'C');


    // Cash Drawer Summary
    // Fetch total cash (excluding negative values)
    $query_total_cash = "SELECT SUM(cash) AS total_cash FROM cash WHERE cash >= 0 AND date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_cash = mysqli_query($connection, $query_total_cash);
    $total_cash_row = mysqli_fetch_assoc($result_total_cash);
    $total_cash = $total_cash_row['total_cash'];

    // Fetch number of transactions
    $query_num_transactions = "SELECT COUNT(*) AS num_transactions FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_num_transactions = mysqli_query($connection, $query_num_transactions);
    $num_transactions_row = mysqli_fetch_assoc($result_num_transactions);
    $num_transactions = $num_transactions_row['num_transactions'];

    // Fetch total pull out
    $query_total_pull_out = "SELECT SUM(cash_pull_out) AS total_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_pull_out = mysqli_query($connection, $query_total_pull_out);
    $total_pull_out_row = mysqli_fetch_assoc($result_total_pull_out);
    $total_pull_out = $total_pull_out_row['total_pull_out'];

    $total_cash = $total_cash - $total_pull_out;

    // Fetch detailed cash entries
    $query_cash_entries = "SELECT date, name, cash, cash_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_cash_entries = mysqli_query($connection, $query_cash_entries);

    // Table data
    $pdf->SetFont('Arial', '', 5);
    while ($row_cash = mysqli_fetch_assoc($result_cash_entries)) {
        $cash_time = date('H:i:s', strtotime($row_cash['date'])); // Format date to show only the time
        $cash_name = $row_cash['name'];
        $cash_amount = $row_cash['cash'];
        $cash_pull_out = $row_cash['cash_pull_out'];

        // Add each cash entry to the table
        $pdf->Cell(15, 2, 'Time:', 0, 0, 'L');
        $pdf->Cell(30, 2, $cash_time, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Name:', 0, 0, 'L');
        $pdf->Cell(30, 2, $cash_name, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Cash:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($cash_amount, 2), 0, 1, 'R');
        $pdf->Cell(15, 2, 'Pull Out:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($cash_pull_out, 2), 0, 1, 'R');
        
        // Add break line
        $pdf->Cell(0, 2, str_repeat('.', 87), 0, 1, 'L');
        $pdf->Ln(0);
    }
    $pdf->Ln(1);

    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Cash Drawer Summary:', 0, 1, 'C');

    $pdf->SetFont('Arial', '', 5);
    $pdf->Cell(0, 2, 'Opening Cash:   $0', 0, 1, 'C');
    $pdf->Cell(0, 2, 'Number of Transactions: ' . $num_transactions, 0, 1, 'C');
    $pdf->Cell(0, 2, 'Total Pull Out: $' . number_format($total_pull_out, 2), 0, 1, 'C');
    $pdf->Cell(0, 2, 'Total Cash: $' . number_format($total_cash, 2), 0, 1, 'C');
    $pdf->Ln(4);

    // Thank you message
    $pdf->SetFont('Arial', 'I', 4);
    $pdf->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
    $pdf->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
    $pdf->Ln(1);

    // Output the PDF
    $pdf->Output('I', 'Hourly_Report' . $date . '.pdf');
?>
