    <?php
    require('../../fpdf/fpdf.php');
    require('../../helper/connect.php');

    session_start();

    // Fetch daily sales data
    date_default_timezone_set('Asia/Manila');
    $date = isset($_SESSION['$selected_date']) ? $_SESSION['$selected_date'] : date('Y-m-d'); // Use session date if set, otherwise current date
    $startOfDay = $date . ' 00:00:00';
    $endOfDay = $date . ' 23:59:59';

    // Create a new PDF instance
    $pdf = new FPDF('P', 'mm', array(83, 55)); // Adjusted width and height for vertical orientation
    $pdf->AddPage();
    $pdf->SetMargins(5, 5, 2); // Set margins
    $pdf->SetAutoPageBreak(true, 5.00);
    // Page header
    $pdf->SetFont('Arial', 'B', 6);
    $pdf->Cell(37, 2, 'CRT Minimart Sales Report', 0, 1, 'C');
    $pdf->Ln(1);

    // Date and time
    $pdf->SetFont('Arial', '', 5);
    $pdf->Cell(0, 2, 'Date: ' . $date, 0, 1, 'C');
    $pdf->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');
    $pdf->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
    $pdf->Ln(1);


    // Sales summary
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Sales Summary:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch total sales
    $query_total_sales = "SELECT SUM(cash_received) AS total_sales FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_sales = mysqli_query($connection, $query_total_sales);
    $total_sales_row = mysqli_fetch_assoc($result_total_sales);
    $total_sales = $total_sales_row['total_sales'];

    // Fetch number of transactions
    $query_num_transactions = "SELECT COUNT(*) AS num_transactions FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_num_transactions = mysqli_query($connection, $query_num_transactions);
    $num_transactions_row = mysqli_fetch_assoc($result_num_transactions);
    $num_transactions = $num_transactions_row['num_transactions'];

    // Fetch total sold item quantity
    $query_total_sold_items = "SELECT SUM(sold) AS total_sold_items FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_total_sold_items = mysqli_query($connection, $query_total_sold_items);
    $total_sold_items_row = mysqli_fetch_assoc($result_total_sold_items);
    $total_sold_items = $total_sold_items_row['total_sold_items'];

    $pdf->SetFont('Arial', '', 5);
    $pdf->Cell(0, 2, 'Total Sales: $' . number_format($total_sales, 2), 0, 1, 'C');
    $pdf->Cell(0, 2, 'Number of Transactions: ' . $num_transactions, 0, 1, 'C');
    $pdf->Cell(0, 2, 'Total Sold Items: ' . $total_sold_items, 0, 1, 'C');
    $pdf->Ln(2);

    // Detailed sales breakdown
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Detailed Sales Breakdown:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch unique categories
    $query_categories = "SELECT DISTINCT category FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_categories = mysqli_query($connection, $query_categories);

    // Prepare data array
    while ($row_category = mysqli_fetch_assoc($result_categories)) {
        $category = $row_category['category'];

        // Fetch total quantity sold for this category
        $query_qty = "SELECT SUM(sold) AS total_qty FROM sale WHERE category = '$category' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_qty = mysqli_query($connection, $query_qty);
        $row_qty = mysqli_fetch_assoc($result_qty);
        $total_qty = $row_qty['total_qty'];

        // Fetch total cash received for this category
        $query_total = "SELECT SUM(cash_received) AS total_cash FROM sale WHERE category = '$category' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total = mysqli_query($connection, $query_total);
        $row_total = mysqli_fetch_assoc($result_total);
        $total_cash = $row_total['total_cash'];

        // Print data
        $pdf->Cell(15, 2, 'Category:', 0, 0, 'L');
        $pdf->Cell(30, 2, $category, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Quantity:', 0, 0, 'L');
        $pdf->Cell(30, 2, $total_qty, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Total Sales:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
        $pdf->Cell(0, 2, str_repeat('.', 90), 0, 1, 'L');
    }

    $pdf->Ln(2);

    // Itemized sales
    $pdf->SetFont('Arial', 'B', 5);
    $pdf->Cell(0, 2, 'Itemized Sales:', 0, 1, 'C');
    $pdf->SetFont('Arial', '', 5);

    // Fetch unique item names
    $query_items = "SELECT DISTINCT name FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
    $result_items = mysqli_query($connection, $query_items);

    // Prepare data array
    while ($row_item = mysqli_fetch_assoc($result_items)) {
        $item_name = $row_item['name'];

        // Fetch total quantity sold for this item
        $query_qty = "SELECT SUM(sold) AS total_qty FROM sale WHERE name = '$item_name' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_qty = mysqli_query($connection, $query_qty);
        $row_qty = mysqli_fetch_assoc($result_qty);
        $total_qty = $row_qty['total_qty'];

        // Fetch total cash received for this item
        $query_total = "SELECT SUM(cash_received) AS total_cash FROM sale WHERE name = '$item_name' AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total = mysqli_query($connection, $query_total);
        $row_total = mysqli_fetch_assoc($result_total);
        $total_cash = $row_total['total_cash'];

        // Print data
        $pdf->Cell(15, 2, 'Product Name:', 0, 0, 'L');
        $pdf->Cell(30, 2, $item_name, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Quantity:', 0, 0, 'L');
        $pdf->Cell(30, 2, $total_qty, 0, 1, 'R');
        $pdf->Cell(15, 2, 'Total Sales:', 0, 0, 'L');
        $pdf->Cell(30, 2, '$' . number_format($total_cash, 2), 0, 1, 'R');
        $pdf->Cell(0, 2, str_repeat('.', 90), 0, 1, 'L');
    }

    // Thank you message
    $pdf->SetFont('Arial', 'I', 4);
    $pdf->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
    $pdf->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
    $pdf->Ln(1);

    // Output the PDF
    $pdf->Output('I', 'Sales_Report' . $date . '.pdf');
    ?>
