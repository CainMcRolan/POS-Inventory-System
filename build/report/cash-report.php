<?php
require('../../fpdf/fpdf.php');
require('../../helper/connect.php');

session_start();

// Fetch daily sales data
date_default_timezone_set('Asia/Manila');
$date = isset($_SESSION['$selected_date']) ? $_SESSION['$selected_date'] : date('Y-m-d'); // Use session date if set, otherwise current date
$startOfDay = $date . ' 00:00:00';
$endOfDay = $date . ' 23:59:59';

// Initialize PDF
$pdf = new FPDF('P', 'mm', array(83, 55));
$pdf->AddPage();
$pdf->SetMargins(5, 5, 2);
$pdf->SetAutoPageBreak(true, 5.00);

// Page header
$pdf->SetFont('Arial', 'B', 6);
$pdf->Cell(37, 2, 'CRT Minimart Cash Report', 0, 1, 'C');
$pdf->Ln(1);

// Date and time
$pdf->SetFont('Arial', '', 5);
$pdf->Cell(0, 2, 'Date: ' . $date, 0, 1, 'C');
$pdf->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');
$pdf->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
$pdf->Ln(1);


// Cash Report
$pdf->SetFont('Arial', 'B', 5);
$pdf->Cell(0, 2, 'Cash Report:', 0, 1, 'C');


// Cash Drawer Summary
// Fetch total cash (excluding negative values)
$query_total_cash = "SELECT SUM(cash) AS total_cash FROM cash WHERE cash >= 0 AND date BETWEEN '$startOfDay' AND '$endOfDay'";
$result_total_cash = mysqli_query($connection, $query_total_cash);
$total_cash_row = mysqli_fetch_assoc($result_total_cash);
$total_cash = $total_cash_row['total_cash'];

// Fetch number of transactions
$query_num_transactions = "SELECT COUNT(*) AS num_transactions FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
$result_num_transactions = mysqli_query($connection, $query_num_transactions);
$num_transactions_row = mysqli_fetch_assoc($result_num_transactions);
$num_transactions = $num_transactions_row['num_transactions'];

// Fetch total pull out
$query_total_pull_out = "SELECT SUM(cash_pull_out) AS total_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
$result_total_pull_out = mysqli_query($connection, $query_total_pull_out);
$total_pull_out_row = mysqli_fetch_assoc($result_total_pull_out);
$total_pull_out = $total_pull_out_row['total_pull_out'];

$total_cash = $total_cash - $total_pull_out;

// Fetch detailed cash entries
$query_cash_entries = "SELECT date, name, cash, cash_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
$result_cash_entries = mysqli_query($connection, $query_cash_entries);

// Table data
$pdf->SetFont('Arial', '', 5);
while ($row_cash = mysqli_fetch_assoc($result_cash_entries)) {
    $cash_time = date('H:i:s', strtotime($row_cash['date'])); // Format date to show only the time
    $cash_name = $row_cash['name'];
    $cash_amount = $row_cash['cash'];
    $cash_pull_out = $row_cash['cash_pull_out'];

    // Add each cash entry to the table
    $pdf->Cell(15, 2, 'Time:', 0, 0, 'L');
    $pdf->Cell(30, 2, $cash_time, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Name:', 0, 0, 'L');
    $pdf->Cell(30, 2, $cash_name, 0, 1, 'R');
    $pdf->Cell(15, 2, 'Cash:', 0, 0, 'L');
    $pdf->Cell(30, 2, '$' . number_format($cash_amount, 2), 0, 1, 'R');
    $pdf->Cell(15, 2, 'Pull Out:', 0, 0, 'L');
    $pdf->Cell(30, 2, '$' . number_format($cash_pull_out, 2), 0, 1, 'R');
    
    // Add break line
    $pdf->Cell(0, 2, str_repeat('.', 87), 0, 1, 'L');
    $pdf->Ln(0);
}
$pdf->Ln(1);

$pdf->SetFont('Arial', 'B', 5);
$pdf->Cell(0, 2, 'Cash Drawer Summary:', 0, 1, 'C');

$pdf->SetFont('Arial', '', 5);
$pdf->Cell(0, 2, 'Opening Cash:   $0', 0, 1, 'C');
$pdf->Cell(0, 2, 'Number of Transactions: ' . $num_transactions, 0, 1, 'C');
$pdf->Cell(0, 2, 'Total Pull Out: $' . number_format($total_pull_out, 2), 0, 1, 'C');
$pdf->Cell(0, 2, 'Total Cash: $' . number_format($total_cash, 2), 0, 1, 'C');
$pdf->Ln(2);

// Thank you message
$pdf->SetFont('Arial', 'I', 4);
$pdf->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
$pdf->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
$pdf->Ln(1);

// Output the PDF
$pdf->Output('I', 'Cash_Report' . $date . '.pdf');
?>
