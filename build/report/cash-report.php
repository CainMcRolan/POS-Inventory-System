<?php
require('../../fpdf/fpdf.php');
require('../../helper/connect.php');

session_start();

// Fetch daily sales data
$date = date('Y-m-d'); // Current date in YYYY-MM-DD format
$startOfDay = $date . ' 00:00:00';
$endOfDay = $date . ' 23:59:59';

$query = "SELECT * FROM sale WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";


class PDF extends FPDF
{
   function __construct($orientation = 'P', $unit = 'mm', $size = 'A4')
   {
       parent::__construct($orientation, $unit, $size);
       $this->SetMargins(2, 2, 2); // Set margins to zero
   }
    // Page header
    function Header()
    {
        // Title
        $this->SetFont('Arial', 'B', 6);
        $this->Cell(0, 2, 'CRT Minimart Cash Report', 0, 1, 'C');
        $this->Ln(1);
        // Date and time
        $this->SetFont('Arial', '', 5);
        $this->Cell(0, 2, 'Date: ' .$_SESSION['$selected_date'], 0, 1, 'C');
        $this->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');
        // Generated by
        $this->Cell(0, 2, 'Report Generated by: Admin', 0, 1, 'C');
        $this->Ln(2);
    }

    function CashDrawerSummary() {
        global $connection;
        $date = $_SESSION['$selected_date']; 
        $startOfDay = $date . ' 00:00:00';
        $endOfDay = $date . ' 23:59:59';
    
        // Fetch total cash
        // Fetch total cash (excluding negative values)
        $query_total_cash = "SELECT SUM(cash) AS total_cash FROM cash WHERE cash >= 0 AND date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total_cash = mysqli_query($connection, $query_total_cash);
        $total_cash_row = mysqli_fetch_assoc($result_total_cash);
        $total_cash = $total_cash_row['total_cash'];
    
        // Fetch number of transactions
        $query_num_transactions = "SELECT COUNT(*) AS num_transactions FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_num_transactions = mysqli_query($connection, $query_num_transactions);
        $num_transactions_row = mysqli_fetch_assoc($result_num_transactions);
        $num_transactions = $num_transactions_row['num_transactions'];
    
        // Fetch total pull out
        $query_total_pull_out = "SELECT SUM(cash_pull_out) AS total_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_total_pull_out = mysqli_query($connection, $query_total_pull_out);
        $total_pull_out_row = mysqli_fetch_assoc($result_total_pull_out);
        $total_pull_out = $total_pull_out_row['total_pull_out'];
    
        $total_cash = $total_cash - $total_pull_out;
    
        // Table headers for detailed cash entries
        $this->Cell(11, 2, 'Time', 1, 0, 'C');
        $this->Cell(10, 2, 'Name', 1, 0, 'C');
        $this->Cell(15, 2, 'Cash', 1, 0, 'C');
        $this->Cell(15, 2, 'Cash Pull Out', 1, 0, 'C');
        $this->Ln();
    
        // Fetch detailed cash entries
        $query_cash_entries = "SELECT date, name, cash, cash_pull_out FROM cash WHERE date BETWEEN '$startOfDay' AND '$endOfDay'";
        $result_cash_entries = mysqli_query($connection, $query_cash_entries);
    
        // Table data
        $this->SetFont('Arial', '', 5);
        while ($row_cash = mysqli_fetch_assoc($result_cash_entries)) {
            $cash_time = date('H:i:s', strtotime($row_cash['date'])); // Format date to show only the time
            $cash_name = $row_cash['name'];
            $cash_amount = $row_cash['cash'];
            $cash_pull_out = $row_cash['cash_pull_out'];
    
            // Add each cash entry to the table
            $this->Cell(11, 2, $cash_time, 1, 0, 'C');
            $this->Cell(10, 2, $cash_name, 1, 0, 'C');
            $this->Cell(15, 2, '$' . number_format($cash_amount, 2), 1, 0, 'C');
            $this->Cell(15, 2, '$' . number_format($cash_pull_out, 2), 1, 0, 'C');
            $this->Ln();
        }
        $this->Ln(2);

        $this->SetFont('Arial', 'B', 5);
        $this->Cell(0, 2, 'Cash Drawer Summary:', 0, 1, 'C');
    
        $this->SetFont('Arial', '', 5);
        $this->Cell(0, 2, 'Opening Cash:   $0', 0, 1, 'C');
        $this->Cell(0, 2, 'Number of Transactions: ' . $num_transactions, 0, 1, 'C');
        $this->Cell(0, 2, 'Total Pull Out: $' . number_format($total_pull_out, 2), 0, 1, 'C');
        $this->Cell(0, 2, 'Total Cash: $' . number_format($total_cash, 2), 0, 1, 'C');
        $this->Ln(2);
    }
    

    // Thank you message
    function ThankYouMessage()
    {
        $this->SetFont('Arial', 'I', 4);
        $this->Cell(0, 2, 'Thank you for your hard work!', 0, 1, 'C');
        $this->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
        $this->Ln(1);
    }
}

// Create a new PDF instance
$pdf = new PDF('P','mm',array(83, 55)); // Adjusted width and height for vertical orientation
$pdf->AddPage();

// Add sections to the PDF
$pdf->CashDrawerSummary();
$pdf->ThankYouMessage();

// Output the PDF
$pdf->Output('I', 'Daily_Terminal_Report_' . $date . '.pdf');
?>
