<?php
require('../../fpdf/fpdf.php');
require('../../helper/connect.php');

session_start();

date_default_timezone_set('Asia/Manila');

// Fetch the latest sales data
$query = "SELECT * FROM sale ORDER BY date DESC LIMIT 1";
$result = mysqli_query($connection, $query);
$sales = [];
if ($result) {
    $latestSale = mysqli_fetch_assoc($result);
    $latestDate = $latestSale['date'];
    $query = "SELECT * FROM sale WHERE date = '$latestDate'";
    $result = mysqli_query($connection, $query);
    while ($row = mysqli_fetch_assoc($result)) {
        $sales[] = $row;
    }
}

// Initialize PDF
$pdf = new FPDF('P','mm',array(83, 55)); // Adjusted width and height for vertical orientation

// Set margins
$pdf->SetMargins(2, 2, 2); // Set margins to zero
$pdf->SetAutoPageBreak(true, 5.00);
// Add a page
$pdf->AddPage();

// Title
$date = date('Y-m-d');
$pdf->SetFont('Arial', 'B', 6);
$pdf->Cell(0, 2, 'CRT Minimart Purchase Receipt', 0, 1, 'C');
$pdf->Ln(1);

// Date and time
$pdf->SetFont('Arial', '', 5);
$pdf->Cell(0, 2, 'Date: ' . $date, 0, 1, 'C');
$pdf->Cell(0, 2, 'Time: ' . date('H:i:s'), 0, 1, 'C');

// Generated by
$pdf->Cell(0, 2, 'Report Generated by: Cashier', 0, 1, 'C');
$pdf->Ln(2);

// Column widths
$w = array(40, 35);

// Table data
$pdf->SetFont('Arial', '', 5);
foreach ($sales as $row) {
    $pdf->Cell($w[0], 3, 'Product Name: ');
    $pdf->Cell($w[1], 3,  $row['name']);
    $pdf->Ln();
    
    $pdf->Cell($w[0], 3, 'Category: ' );
    $pdf->Cell($w[1], 3,  $row['category']);
    $pdf->Ln();

    $pdf->Cell($w[0], 3, 'Quantity: ' );
    $pdf->Cell($w[1], 3,  $row['sold']);

    $pdf->Ln();

    $pdf->Cell($w[0], 3, 'Price: ' );
    $pdf->Cell($w[1], 3, '$'. number_format($row['cash_received'], 2));
    $pdf->Ln();
    
    // Dot page break
    $pdf->Cell(0, 3, '.....................................................................................................');
    $pdf->Ln();
}


// Total amount
$totalAmount = array_sum(array_column($sales, 'cash_received'));

// Cash
$pdf->Cell(0, 3, 'Cash: $' . number_format($totalAmount, 2));
$pdf->Ln();

$pdf->Cell(0, 3, 'Total Amount: $' . number_format($totalAmount, 2));
$pdf->Ln(5);

$pdf->Image('../../assets/qrcode.png', 22, $pdf->GetY(), 12);
$pdf->Ln(12);
// Thank you message
$pdf->SetFont('Arial', 'I', 4);
$pdf->Cell(0, 2, 'Thank you for your purchase!', 0, 1, 'C');
$pdf->Cell(0, 2, 'For inquiries, contact: +956-143-4976', 0, 1, 'C');
$pdf->Ln(1);



// Output the PDF
$pdf->Output('I', 'receipt' . date('Y-m-d') . '.pdf');
?>
